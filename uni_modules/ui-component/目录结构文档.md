# UI-Component 目录结构文档

## 项目概述

本项目是一个基于 UTS 技术的 UniApp 组件库，主要提供登录状态管理、直播状态管理、直播座位状态管理和直播观众状态管理功能。采用分层架构设计，支持 Android 和 iOS 双平台。

**项目信息：**
- 项目名称：ui-component  
- 版本：1.0.0
- 技术栈：UTS + Vue3 + TypeScript
- 支持平台：Android、iOS

## 目录结构

```
uni_modules/ui-component/
├── package.json                          # 项目配置文件
├── 目录结构文档.md                        # 本文档
├── LiveSeatState_转化总结.md               # LiveSeatState转化总结
├── LiveAudienceState_转化总结.md          # LiveAudienceState转化总结
├── state/                                 # Vue 状态管理层
│   ├── loginstate.ts                     # 登录状态 Vue 封装
│   ├── livestate.ts                      # 直播状态 Vue 封装
│   ├── liveseatstate.ts                  # 直播座位状态 Vue 封装
│   └── liveaudiencestate.ts              # 直播观众状态 Vue 封装
└── utssdk/                               # UTS 原生封装层
    ├── interface.uts                     # 类型定义文件
    ├── index.uts                         # 主导出入口文件
    ├── app-android/                      # Android 平台实现
    │   ├── index.uts                     # Android 导出入口
    │   ├── config.json                   # Android 配置文件
    │   ├── libs/                         # Android 依赖库
    │   │   └── rtc-debug.aar            # TRTC SDK 库文件
    │   ├── LoginState/                   # 登录功能模块
    │   │   ├── LoginState.kt            # 登录原生实现 (Kotlin)
    │   │   ├── loginstate.uts           # 登录 UTS 封装
    │   │   └── LoginStateEventObserver.kt # 登录事件观察器
    │   ├── LiveState/                    # 直播功能模块
    │   │   ├── LiveState.kt             # 直播原生实现 (Kotlin)
    │   │   ├── LiveState.uts            # 直播 UTS 封装
    │   │   └── LiveStateEventObserver.kt # 直播事件观察器
    │   ├── LiveSeatState/                # 直播座位功能模块
    │   │   ├── LiveSeatState.kt         # 座位原生实现 (Kotlin)
    │   │   ├── LiveSeatState.uts        # 座位 UTS 封装
    │   │   └── LiveSeatStateEventObserver.kt # 座位事件观察器
    │   └── LiveAudienceState/            # 直播观众功能模块
    │       ├── LiveAudienceState.kt     # 观众原生实现 (Kotlin)
    │       ├── LiveAudienceState.uts    # 观众 UTS 封装
    │       └── LiveAudienceStateEventObserver.kt # 观众事件观察器
    └── app-ios/                          # iOS 平台实现
        ├── index.uts                     # iOS 导出入口
        ├── config.json                   # iOS 配置文件
        └── LiveState.uts                 # iOS 直播实现
```

## 文件详细说明

### 📦 根目录文件

#### `package.json`
项目的核心配置文件，定义了：
- 插件基本信息（名称、版本、描述）
- 平台支持情况（Vue3、Android、iOS）
- 依赖声明和权限要求

#### `LiveSeatState_转化总结.md`
LiveSeatState 转化过程的详细记录文档

#### `LiveAudienceState_转化总结.md`
LiveAudienceState 转化过程的详细记录文档

### 🎨 Vue 状态管理层 (`state/`)

#### `loginstate.ts` 
登录状态的 Vue Composition API 封装
- **功能**：提供登录、登出、设置用户信息等方法
- **状态**：`loginUserInfo`、`loginState`
- **特点**：最简化调用，状态通过事件自动更新
- **导出**：`useLoginState()` Hook

#### `livestate.ts`
直播状态的 Vue Composition API 封装  
- **功能**：提供直播列表获取、创建直播、加入直播等方法
- **状态**：`liveList`、`currentLive`、`localLiveStatus`、`liveListCursor`
- **特点**：事件驱动的状态管理
- **导出**：`useLiveState()` Hook

#### `liveseatstate.ts`
直播座位状态的 Vue Composition API 封装
- **功能**：提供视频视图绑定、座位锁定、座位移动等方法
- **状态**：`seatList`、`canvas`
- **特点**：座位管理专用，支持视频交互
- **导出**：`useLiveSeatState()` Hook

#### `liveaudiencestate.ts`
直播观众状态的 Vue Composition API 封装
- **功能**：提供获取观众列表、设置管理员、踢出用户、禁用发言等方法
- **状态**：`audienceList`、`audienceListCursor`
- **特点**：观众管理专用，支持权限控制
- **导出**：`useLiveAudienceState()` Hook

### 🔧 UTS 原生封装层 (`utssdk/`)

#### `interface.uts`
全局类型定义文件
- **内容**：定义所有接口、类型、枚举
- **类型**：`LoginOptions`、`LiveInfo`、`SeatInfo`、`LiveCanvas`、`AudienceInfo` 等
- **特点**：使用接口继承而非交叉类型，确保 UTS 兼容性

#### `index.uts`
UTS 插件主入口文件
- **功能**：导出所有管理器类和事件监听函数
- **管理器**：`LoginStateManager`、`LiveStateManager`、`LiveSeatStateManager`、`LiveAudienceStateManager`
- **事件**：所有 `onXxxChanged` 事件监听函数

#### Android 平台 (`app-android/`)

**配置文件：**
- `index.uts`: Android 平台的总导出入口
- `config.json`: Android 平台编译配置

**登录模块 (`LoginState/`)：**
- `LoginState.kt`: Kotlin 原生登录逻辑，包含单例模式和 StateFlow 状态管理
- `loginstate.uts`: UTS 层封装，提供 `LoginStateManager` 类
- `LoginStateEventObserver.kt`: 事件观察器，监听状态变化并发射事件

**直播模块 (`LiveState/`)：**
- `LiveState.kt`: Kotlin 原生直播逻辑，完整的直播功能实现
- `LiveState.uts`: UTS 层封装，提供 `LiveStateManager` 类  
- `LiveStateEventObserver.kt`: 直播事件观察器，监听4个状态变化

**座位模块 (`LiveSeatState/`)：**
- `LiveSeatState.kt`: Kotlin 原生座位逻辑，包含座位管理和视频交互
- `LiveSeatState.uts`: UTS 层封装，提供 `LiveSeatStateManager` 类
- `LiveSeatStateEventObserver.kt`: 座位事件观察器，监听2个状态变化

**观众模块 (`LiveAudienceState/`)：**
- `LiveAudienceState.kt`: Kotlin 原生观众逻辑，包含观众管理和权限控制
- `LiveAudienceState.uts`: UTS 层封装，提供 `LiveAudienceStateManager` 类
- `LiveAudienceStateEventObserver.kt`: 观众事件观察器，监听2个状态变化

**依赖库 (`libs/`)：**
- `rtc-debug.aar`: TRTC SDK 的 Android 实现库

#### iOS 平台 (`app-ios/`)

**配置文件：**
- `index.uts`: iOS 平台的导出入口，包含完整的实现逻辑
- `config.json`: iOS 平台编译配置

**实现文件：**
- `LiveState.uts`: iOS 平台的直播功能实现

## 架构设计原则

### 分层架构
```
Vue 应用层 (state/*.ts)
    ↓ 事件通信
UTS 封装层 (utssdk/*.uts)  
    ↓ 原生调用
原生实现层 (*.kt / iOS原生)
```

### 数据流转
```
原生 StateFlow → 事件观察器 → uni.$emit → Vue 监听 → 响应式状态
```

### 类型设计
- **UTS层**：完整的 Options 接口（包含 success/fail 回调）
- **Vue层**：简化的 Params 类型（只包含业务参数）

## 新增文件指导

### 🆕 添加新的 State 功能

假设要添加 `ChatState` 聊天功能，按以下步骤操作：

#### Step 1: 定义类型接口
在 `utssdk/interface.uts` 中添加：

```typescript
// Chat 相关类型定义
export type ChatMessage = {
    messageId: string;
    content: string;
    senderId: string;
    timestamp: number;
}

export type ChatStatus = 'CONNECTED' | 'DISCONNECTED' | 'CONNECTING';

// Chat Options 接口
export interface SendMessageOptions extends BaseOptions {
    message: ChatMessage;
}

export interface JoinChatOptions extends BaseOptions {
    chatRoomId: string;
}
```

#### Step 2: 创建 Android 实现

**创建目录：**
```bash
mkdir utssdk/app-android/ChatState
```

**添加文件：**

1. `utssdk/app-android/ChatState/ChatState.kt`
```kotlin
// Kotlin 原生实现
class ChatState private constructor() {
    companion object {
        val shared by lazy(LazyThreadSafetyMode.SYNCHRONIZED) {
            ChatState()
        }
        
        @JvmStatic
        fun getInstance(): ChatState = shared
    }
    
    // StateFlow 状态管理
    private val _chatMessages = MutableStateFlow<List<ChatMessage>>(emptyList())
    val chatMessages: StateFlow<List<ChatMessage>> = _chatMessages.asStateFlow()
    
    // 业务方法实现
    fun sendMessage(message: ChatMessage, callback: ActionCallback) {
        // 实现发送消息逻辑
    }
}
```

2. `utssdk/app-android/ChatState/ChatState.uts`
```typescript
// UTS 封装层
export class ChatStateManager {
    private static _instance : ChatStateManager | null = null;
    
    public static getInstance() : ChatStateManager {
        if (!this._instance) {
            this._instance = new ChatStateManager();
        }
        return this._instance!;
    }
    
    public sendMessage(options: SendMessageOptions) {
        // 调用原生方法
    }
}

// 事件导出
export const onChatMessagesChanged = function (callback : (res : string) => void) {
    ChatStateEventObserver.getInstance().onChatMessagesChanged(function (res : string) {
        uni.$emit('onChatMessagesChanged', JSON.stringify(res))
    })
}
```

3. `utssdk/app-android/ChatState/ChatStateEventObserver.kt`
```kotlin
// 事件观察器
class ChatStateEventObserver {
    fun onChatMessagesChanged(callback: (String) -> Unit) {
        val bindDataJob: Job = CoroutineScope(Dispatchers.Main).launch {
            ChatState.getInstance().chatMessages.collect {
                callback(it.toString())
            }
        }
    }
    
    companion object {
        val shared by lazy(LazyThreadSafetyMode.SYNCHRONIZED) {
            ChatStateEventObserver()
        }
        
        @JvmStatic
        fun getInstance(): ChatStateEventObserver = shared
    }
}
```

#### Step 3: 更新 Android 导出

在 `utssdk/app-android/index.uts` 中添加：
```typescript
import { ChatStateManager } from './ChatState/ChatState.uts'

export { LoginStateManager, LiveStateManager, LiveSeatStateManager, ChatStateManager }
```

#### Step 4: 更新主入口

在 `utssdk/index.uts` 中添加：
```typescript
export { 
    LoginStateManager, 
    LiveStateManager, 
    LiveSeatStateManager,
    ChatStateManager,  // 新增
    // ... 事件监听函数
} from './app-android/index.uts'
```

#### Step 5: 创建 iOS 实现

在 `utssdk/app-ios/index.uts` 中添加 ChatState 的 iOS 实现

#### Step 6: 创建 Vue 封装

创建 `state/chatstate.ts`：
```typescript
import { ref } from "vue";
import {
    ChatStateManager,
    ChatMessage,
    ChatStatus
} from "@/uni_modules/ui-component";

// Vue层专用的简化参数类型
type SendMessageParams = {
    message: ChatMessage;
};

type JoinChatParams = {
    chatRoomId: string;
};

// 响应式状态
const chatMessages = ref<ChatMessage[]>([]);
const chatStatus = ref<ChatStatus>('DISCONNECTED');

// 管理器实例
const chatStateManager = ChatStateManager.getInstance();

// 方法封装
function sendMessage(params: SendMessageParams) {
    chatStateManager.sendMessage(params);
}

function joinChat(params: JoinChatParams) {
    chatStateManager.joinChat(params);
}

// 事件监听
const onChatMessagesChanged = (res: string) => {
    try {
        const data = JSON.parse(res);
        chatMessages.value = data.messages || [];
    } catch (error) {
        console.error('onChatMessagesChanged JSON parse error:', error);
    }
};

// 事件绑定
function bindEvent() {
    uni.$on("onChatMessagesChanged", onChatMessagesChanged);
}

function unBindEvent() {
    uni.$off("onChatMessagesChanged", onChatMessagesChanged);
}

// Composition API 导出
export function useChatState() {
    return {
        // 响应式状态
        chatMessages,
        chatStatus,
        
        // 操作方法
        sendMessage,
        joinChat,
        
        // 事件管理
        bindEvent,
        unBindEvent,
    };
}

// 初始化
bindEvent();

export default useChatState;
```

### 🔄 修改现有功能

#### 添加新方法到现有 State

以在 `LiveState` 中添加 `muteLive` 方法为例：

1. **更新类型定义** (`utssdk/interface.uts`)：
```typescript
export interface MuteLiveOptions extends BaseOptions {
    liveId: string;
    muted: boolean;
}
```

2. **更新 Kotlin 实现** (`utssdk/app-android/LiveState/LiveState.kt`)：
```kotlin
fun muteLive(liveId: String, muted: Boolean, callback: ActionCallback) {
    // 实现静音逻辑
}
```

3. **更新 UTS 封装** (`utssdk/app-android/LiveState/LiveState.uts`)：
```typescript
public muteLive(options: MuteLiveOptions) {
    this.liveState.muteLive(
        options.liveId,
        options.muted,
        this.createActionCallback(options)
    );
}
```

4. **更新 Vue 封装** (`state/livestate.ts`)：
```typescript
type MuteLiveParams = {
    liveId: string;
    muted: boolean;
};

function muteLive(params: MuteLiveParams) {
    liveStateManager.muteLive(params);
}

// 在 useLiveState 返回值中添加
export function useLiveState() {
    return {
        // ... 现有内容
        muteLive,  // 新增方法
    };
}
```

## 开发规范

### 🎯 命名规范

- **文件命名**：小写字母 + 连字符（如：`loginstate.ts`）
- **类命名**：PascalCase（如：`LoginStateManager`）
- **函数命名**：camelCase（如：`fetchLiveList`）
- **类型命名**：PascalCase（如：`LoginOptions`、`LiveInfo`）

### 🏗️ 架构规范

1. **分层原则**：严格按照 Vue层 → UTS层 → 原生层 的分层架构
2. **类型设计**：UTS层使用完整Options，Vue层使用简化Params  
3. **状态管理**：使用事件驱动的响应式状态管理
4. **错误处理**：各层都要有完善的错误处理和日志记录

### 🔧 技术规范

1. **UTS限制**：不支持交叉类型，使用接口继承代替
2. **回调设计**：UTS层包含success/fail回调，Vue层无回调
3. **事件命名**：以 `on` 开头，如 `onLoginInfoChanged`
4. **方法调用**：Vue层使用最简化调用，状态通过事件更新

## 🚀 快速开始

### 使用现有功能

```typescript
import { useLoginState, useLiveState, useLiveSeatState } from '@/uni_modules/ui-component/state'

// 登录功能
const { loginUserInfo, login, logout } = useLoginState()

login({
    sdkAppID: 12345,
    userID: 'user123',
    userSig: 'your_user_sig'
})

// 直播功能  
const { liveList, fetchLiveList, createLive } = useLiveState()

fetchLiveList({
    category: 1,
    count: 20
})

// 座位功能
const { seatList, lockSeat, moveToSeat } = useLiveSeatState()

lockSeat({
    seatIndex: 1,
    lockMode: 'LOCK_ALL'
})
```

### 添加新功能

1. 按照上述 "新增文件指导" 的步骤操作
2. 参考现有的 `LoginState`、`LiveState` 或 `LiveSeatState` 实现
3. 遵循架构设计原则和开发规范
4. 进行充分的测试验证

## 📝 总结

本项目采用现代化的分层架构设计，通过 UTS 技术实现了 Vue 应用与原生平台的无缝集成。完善的类型系统和事件驱动机制确保了代码的类型安全和状态一致性。

**核心特点：**
- 🏗️ 分层架构，职责清晰
- 🎯 类型安全，开发友好  
- 📡 事件驱动，状态同步
- 🔄 最简调用，易于使用
- 🛡️ 错误处理，稳定可靠

**功能模块：**
- 🔐 **LoginState** - 用户登录状态管理
- 📹 **LiveState** - 直播状态管理  
- 🪑 **LiveSeatState** - 直播座位状态管理
- 🧑 **LiveAudienceState** - 直播观众状态管理

遵循本文档的指导，可以高效地开发和维护 UI-Component 功能模块。 